<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Coding Mission (Age 12-15)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="DataManager.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-editor: #1e1e2e;
            --text-code: #abb2bf;
            --keyword: #ff79c6;
            --function: #8be9fd;
            --number: #bd93f9;
            --string: #f1fa8c;
            --comment: #6272a4;
            --operator: #ffb86c;
            --accent: #38bdf8;
            --success: #50fa7b;
            --danger: #ff5555;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { margin: 0; height: 100vh; background: var(--bg-dark); color: white; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: #020617; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; }
        .logo { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.4rem; color: var(--accent); display: flex; align-items: center; gap: 10px; }
        .header-right { display: flex; gap: 15px; align-items: center; }
        .level-badge { background: #334155; padding: 5px 15px; border-radius: 4px; font-size: 0.9rem; font-family: monospace; }
        .sound-btn { background: none; border: 1px solid #334155; color: #94a3b8; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .sound-btn:hover { background: #1e293b; color: white; }
        main { flex: 1; display: flex; height: calc(100vh - 60px); }
        .editor-panel { width: 40%; min-width: 400px; background: var(--bg-editor); display: flex; flex-direction: column; border-right: 1px solid #334155; }
        .editor-header { padding: 10px 15px; background: #13131f; font-size: 0.9rem; color: #94a3b8; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        .code-container { flex: 1; position: relative; display: flex; overflow: hidden; background: var(--bg-editor); }
        .line-numbers { width: 45px; background: #181824; color: #4b5263; text-align: right; padding: 10px 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 15px; line-height: 24px; user-select: none; border-right: 1px solid #333; z-index: 5; }
        .editor-content { position: absolute; top: 0; bottom: 0; right: 0; left: 45px; padding: 10px; font-family: 'Consolas', 'Monaco', monospace; font-size: 15px; line-height: 24px; white-space: pre; overflow: auto; border: none; margin: 0; }
        textarea#code-input { z-index: 2; color: transparent; background: transparent; caret-color: #fff; outline: none; resize: none; }
        #code-highlight { z-index: 1; color: var(--text-code); pointer-events: none; display: block; }
        .console-log { height: 150px; background: #13131f; border-top: 1px solid #334155; padding: 10px; font-family: 'Consolas', monospace; font-size: 13px; color: #94a3b8; overflow-y: auto; }
        .log-line { margin-bottom: 4px; display: block; }
        .log-error { color: var(--danger); }
        .log-success { color: var(--success); }
        .log-info { color: var(--accent); }
        .editor-controls { padding: 10px; display: flex; gap: 10px; background: #13131f; }
        .game-panel { flex: 1; background: #334155; position: relative; display: flex; flex-direction: column; }
        .mission-bar { background: rgba(0,0,0,0.3); padding: 15px; color: white; display: flex; gap: 15px; align-items: center; backdrop-filter: blur(5px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .mission-icon { font-size: 2rem; }
        .mission-text h3 { margin: 0 0 5px 0; font-size: 1rem; color: var(--accent); }
        .mission-text p { margin: 0; font-size: 0.9rem; color: #cbd5e1; }
        .stage-area { flex: 1; display: flex; justify-content: center; align-items: center; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px; position: relative; overflow: hidden; }
        #grid-container { display: grid; gap: 4px; background: #1e293b; padding: 10px; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; transition: transform 0.3s; }
        .cell { width: 60px; height: 60px; background: #334155; border-radius: 4px; display: flex; justify-content: center; align-items: center; position: relative; }
        .cell-floor { background: #475569; }
        .cell-wall { background: #1e293b; border: 1px solid #334155; background-image: repeating-linear-gradient(45deg, #1e293b 0, #1e293b 10px, #0f172a 10px, #0f172a 20px); }
        .player { width: 50px; height: 50px; position: absolute; z-index: 20; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .player svg { filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); width: 100%; height: 100%; }
        .item { width: 35px; height: 35px; z-index: 10; animation: float 2s infinite ease-in-out; }
        .goal { width: 50px; height: 50px; z-index: 5; }
        .btn { border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: 'Segoe UI', sans-serif; transition: 0.2s; }
        .btn-run { background: var(--success); color: #000; flex: 2; justify-content: center; }
        .btn-run:hover { background: #4ade80; }
        .btn-reset { background: #475569; color: white; flex: 1; justify-content: center; }
        .btn-reset:hover { background: #64748b; }
        .helper-sidebar { width: 180px; background: #0f172a; border-left: 1px solid #334155; padding: 15px; overflow-y: auto; font-size: 0.85rem; }
        .helper-title { color: #64748b; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; font-size: 0.75rem; }
        .cmd-item { background: #1e293b; padding: 8px; margin-bottom: 8px; border-radius: 4px; cursor: pointer; border: 1px solid #334155; transition: 0.2s; }
        .cmd-item:hover { border-color: var(--function); background: #263344; }
        .cmd-code { color: var(--function); font-family: monospace; display: block; margin-bottom: 2px; }
        .cmd-desc { color: #94a3b8; font-size: 0.75rem; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-box { background: #1e293b; padding: 2rem; border-radius: 8px; text-align: center; border: 1px solid #475569; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal h2 { margin-top: 0; color: var(--accent); }
        .inventory-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px; display: flex; gap: 5px; font-size: 0.8rem; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .hl-keyword { color: var(--keyword); font-weight: bold; }
        .hl-func { color: var(--function); }
        .hl-num { color: var(--number); }
        .hl-str { color: var(--string); }
        .hl-comment { color: var(--comment); font-style: italic; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(30,30,46,0.95); z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 10px; color: #38bdf8; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div>Loading Mission Data...</div>
    <svg style="animation: spin 1s linear infinite" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>
</div>

<header>
    <div class="logo">
        <span>&lt;_DevMission&gt;</span>
    </div>
    <div class="header-right">
        <button class="sound-btn" onclick="sound.toggle()" id="btn-sound">üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î</button>
        <div class="level-badge" id="level-display">LEVEL 01</div>
    </div>
</header>

<main>
    <div class="editor-panel">
        <div class="editor-header"><span>solution.py</span><span>Python 3.x Environment</span></div>
        <div class="code-container">
            <div class="line-numbers" id="line-numbers">1</div>
            <pre id="code-highlight" class="editor-content"></pre>
            <textarea id="code-input" class="editor-content" spellcheck="false" placeholder="# ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
        </div>
        <div class="console-log" id="console-output"><span class="log-line">> System initialized...</span><span class="log-line">> Waiting for input...</span></div>
        <div class="editor-controls">
            <button class="btn btn-reset" onclick="game.resetLevel()">‚Ü∫ Reset</button>
            <button class="btn btn-run" onclick="game.runCode()">‚ñ∂ Run Code</button>
        </div>
    </div>
    <div class="game-panel">
        <div class="mission-bar">
            <div class="mission-icon" id="mission-icon">üîß</div>
            <div class="mission-text">
                <h3 id="mission-title">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h3>
                <p id="mission-desc">‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÑ‡∏õ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</p>
            </div>
            <div class="inventory-badge" id="inventory-display">üéí ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤: ‡πÑ‡∏°‡πà‡∏°‡∏µ</div>
        </div>
        <div class="stage-area">
            <div id="grid-container"></div>
        </div>
    </div>
    <div class="helper-sidebar">
        <div class="helper-title">Commands (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á)</div>
        <div class="cmd-item" onclick="editor.insert('move_forward()')"><span class="cmd-code">move_forward(n)</span><span class="cmd-desc">‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ n ‡∏ä‡πà‡∏≠‡∏á</span></div>
        <div class="cmd-item" onclick="editor.insert('turn_left()')"><span class="cmd-code">turn_left()</span><span class="cmd-desc">‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ 90¬∞</span></div>
        <div class="cmd-item" onclick="editor.insert('turn_right()')"><span class="cmd-code">turn_right()</span><span class="cmd-desc">‡∏´‡∏±‡∏ô‡∏Ç‡∏ß‡∏≤ 90¬∞</span></div>
        <div class="helper-title" style="margin-top: 20px;">Actions (‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥)</div>
        <div class="cmd-item" onclick="editor.insert('collect()')"><span class="cmd-code">collect()</span><span class="cmd-desc">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ï‡∏£‡∏á‡πÄ‡∏ó‡πâ‡∏≤</span></div>
        <div class="cmd-item" onclick="editor.insert('repair()')"><span class="cmd-code">repair()</span><span class="cmd-desc">‡∏ã‡πà‡∏≠‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏á)</span></div>
        <div class="cmd-item" onclick="editor.insert('buy()')"><span class="cmd-code">buy()</span><span class="cmd-desc">‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç)</span></div>
    </div>
</main>

<div class="modal" id="modal-win">
    <div class="modal-box" style="border-color: var(--success);">
        <h2 style="color: var(--success);">MISSION COMPLETE!</h2>
        <p>‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏≠‡∏±‡∏•‡∏Å‡∏≠‡∏£‡∏¥‡∏ó‡∏∂‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
        <button class="btn btn-run" style="width:100%; margin-top:15px;" onclick="game.nextLevel()">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
    </div>
</div>

<div class="modal" id="modal-fail">
    <div class="modal-box" style="border-color: var(--danger);">
        <h2 style="color: var(--danger);">RUNTIME ERROR</h2>
        <p id="fail-msg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
        <button class="btn btn-reset" style="width:100%; margin-top:15px;" onclick="game.resetLevel()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î ‚Ü∫</button>
    </div>
</div>

<script>
    const sound = {
        ctx: null, enabled: true,
        init() { if (!this.ctx) { window.AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); } if (this.ctx.state === 'suspended') { this.ctx.resume(); } },
        toggle() { this.enabled = !this.enabled; const btn = document.getElementById('btn-sound'); btn.innerText = this.enabled ? "üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î" : "üîá ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î"; btn.style.color = this.enabled ? "#94a3b8" : "#ef4444"; },
        play(type) {
            if (!this.enabled) return; this.init(); const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination);
            if (type === 'move') { osc.type = 'sine'; osc.frequency.setValueAtTime(300, t); gain.gain.setValueAtTime(0.1, t); osc.start(t); osc.stop(t + 0.1); } 
            else if (type === 'turn') { osc.type = 'triangle'; osc.frequency.setValueAtTime(200, t); gain.gain.setValueAtTime(0.05, t); osc.start(t); osc.stop(t + 0.1); }
            else if (type === 'collect') { osc.type = 'sine'; osc.frequency.setValueAtTime(1200, t); gain.gain.setValueAtTime(0.1, t); osc.start(t); osc.stop(t + 0.2); }
            else if (type === 'action') { osc.type = 'square'; osc.frequency.setValueAtTime(400, t); gain.gain.setValueAtTime(0.1, t); osc.start(t); osc.stop(t + 0.3); }
            else if (type === 'win') { [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => { const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination); o.frequency.value = f; o.type = 'sine'; g.gain.setValueAtTime(0.1, t + i*0.1); o.start(t + i*0.1); o.stop(t + i*0.1 + 0.3); }); }
            else if (type === 'fail') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); gain.gain.setValueAtTime(0.1, t); osc.start(t); osc.stop(t + 0.5); }
        }
    };

    const ICONS = {
        player: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="5" width="14" height="14" rx="3" fill="#3b82f6" stroke="#1e40af"/><circle cx="8" cy="9" r="2" fill="white" stroke="none"/><circle cx="16" cy="9" r="2" fill="white" stroke="none"/><path d="M12 2 L16 6 L8 6 Z" fill="#facc15" stroke="none"/> <path d="M7 21v-3h2v3M15 21v-3h2v3" stroke="#94a3b8"/></svg>`,
        screwdriver: `<svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M14 2l4 4L7 17H3v-4L14 2z"/><path d="M3 21h4"/></svg>`,
        coin: `<svg viewBox="0 0 24 24" fill="#facc15" stroke="#b45309" stroke-width="2"><circle cx="12" cy="12" r="9"/><text x="12" y="16" font-size="12" text-anchor="middle" fill="#b45309" stroke="none" font-weight="bold">$</text></svg>`,
        server_broken: `<svg viewBox="0 0 24 24" fill="#1e293b" stroke="#ef4444" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><path d="M9 16l6 4M15 16l-6 4" stroke-width="3"/></svg>`,
        server_fixed: `<svg viewBox="0 0 24 24" fill="#1e293b" stroke="#22c55e" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><circle cx="12" cy="16" r="2" fill="#22c55e" stroke="none"/></svg>`,
        vending: `<svg viewBox="0 0 24 24" fill="#334155" stroke="#a78bfa" stroke-width="2"><rect x="6" y="2" width="12" height="20" rx="2"/><rect x="9" y="6" width="6" height="6" fill="#1e293b"/><rect x="9" y="16" width="6" height="2"/></svg>`
    };

    const LEVELS = [
        { map: [[1,1,1,1,1],[1,9,0,3,1],[1,1,1,1,1]], w:5, h:3, dir:1, items:[], req:'repair', hint:"‡∏û‡∏¥‡∏°‡∏û‡πå repair() ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£" },
        { map: [[1,1,1,1,1,1],[1,9,0,0,0,3],[1,1,1,1,1,1]], w:6, h:3, dir:1, items:[], req:'repair', hint:"‡πÉ‡∏ä‡πâ move_forward(4) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏¢‡∏≤‡∏ß‡πÜ" },
        { map: [[1,1,1],[1,3,1],[1,0,1],[1,9,1]], w:3, h:4, dir:0, items:[], req:'repair', hint:"‡πÅ‡∏Ñ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏ã‡πà‡∏≠‡∏°" },
        { map: [[1,1,1,1],[1,9,0,1],[1,1,0,3],[1,1,1,1]], w:4, h:4, dir:1, items:[], req:'repair', hint:"‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤, ‡∏´‡∏±‡∏ô‡∏Ç‡∏ß‡∏≤, ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤, ‡∏ã‡πà‡∏≠‡∏°" },
        { map: [[1,1,1,1,1],[1,9,0,0,3],[1,1,1,1,1]], w:5, h:3, dir:1, items:[], req:'repair', hint:"‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ 2 ‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏ã‡πà‡∏≠‡∏°" },
        { map: [[1,1,1,1,1],[1,9,2,0,3],[1,1,1,1,1]], w:5, h:3, dir:1, items:['screwdriver'], req:'repair', hint:"‡∏ï‡πâ‡∏≠‡∏á collect() ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°" },
        { map: [[1,1,1,1],[1,9,1,3],[1,2,0,0],[1,1,1,1]], w:4, h:4, dir:1, items:['screwdriver'], req:'repair', hint:"‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡∏¥‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡πà‡∏≠‡∏°" },
        { map: [[1,1,1,1,1],[1,3,1,2,1],[1,0,0,0,1],[1,0,1,1,1],[1,9,1,1,1]], w:5, h:5, dir:0, items:['screwdriver'], req:'repair', hint:"‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏î‡πÄ‡∏Ñ‡∏µ‡πâ‡∏¢‡∏ß" },
        { map: [[1,1,1],[1,2,1],[1,0,1],[1,9,1],[1,0,1],[1,3,1]], w:3, h:6, dir:0, items:['screwdriver'], req:'repair', hint:"‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏≠‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡πà‡∏≠?" },
        { map: [[1,1,1,1],[1,2,0,9],[1,1,0,3],[1,1,1,1]], w:4, h:4, dir:3, items:['screwdriver'], req:'repair', hint:"‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô" },
        { map: [[1,1,1,1,1],[1,9,4,0,5],[1,1,1,1,1]], w:5, h:3, dir:1, items:['coin'], req:'buy', hint:"‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô collect() ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á buy()" },
        { map: [[1,1,1,1,1],[1,5,1,4,1],[1,0,0,0,1],[1,1,1,9,1]], w:5, h:4, dir:0, items:['coin'], req:'buy', hint:"‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏π‡πâ" },
        { map: [[1,1,1,1],[1,4,0,5],[1,0,1,1],[1,9,1,1]], w:4, h:4, dir:0, items:['coin'], req:'buy', hint:"‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" },
        { map: [[1,1,1,1,1],[1,5,0,0,9],[1,1,1,0,1],[1,4,0,0,1],[1,1,1,1,1]], w:5, h:5, dir:3, items:['coin'], req:'buy', hint:"‡∏ó‡∏≤‡∏á‡∏≠‡πâ‡∏≠‡∏°" },
        { map: [[1,1,1,1,1],[1,9,0,0,1],[1,1,1,4,1],[1,1,1,0,1],[1,5,0,0,1]], w:5, h:5, dir:1, items:['coin'], req:'buy', hint:"‡πÄ‡∏î‡∏¥‡∏ô‡∏ß‡∏ô‡πÑ‡∏õ" },
        { map: [[1,1,1,1,1,1],[1,9,0,2,0,3],[1,1,1,1,1,1]], w:6, h:3, dir:1, items:['screwdriver'], req:'repair', hint:"‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥" },
        { map: [[1,1,1,1,1],[1,3,0,0,1],[1,1,1,0,1],[1,2,0,0,1],[1,9,1,1,1]], w:5, h:5, dir:0, items:['screwdriver'], req:'repair', hint:"‡πÄ‡∏î‡∏¥‡∏ô‡∏≠‡πâ‡∏≠‡∏°‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á" },
        { map: [[1,1,1,1,1],[1,9,0,1,5],[1,1,4,1,0],[1,1,1,1,1]], w:5, h:4, dir:1, items:['coin'], req:'buy', hint:"‡∏ó‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ö ‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÜ" },
        { map: [[1,1,1,1,1],[1,2,0,9,0],[1,1,1,1,0],[1,3,0,0,0],[1,1,1,1,1]], w:5, h:5, dir:1, items:['screwdriver'], req:'repair', hint:"‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤" },
        { map: [[1,1,1,1,1,1],[1,4,0,9,0,5],[1,1,1,1,1,1]], w:6, h:3, dir:1, items:['coin'], req:'buy', hint:"‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ô (turn 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)" }
    ];

    function generateRandomLevel(levelIndex) {
        const w = 6 + Math.floor(Math.random() * 2); 
        const h = 5 + Math.floor(Math.random() * 3); 
        let map = Array(h).fill().map(() => Array(w).fill(1));
        let startX = 1 + Math.floor(Math.random() * (w-2));
        let startY = 1 + Math.floor(Math.random() * (h-2));
        map[startY][startX] = 9;
        let currentX = startX, currentY = startY, itemX, itemY;
        let steps = 0;
        while(steps < 4) {
            let dir = Math.floor(Math.random() * 4);
            let nx = currentX + [0, 1, 0, -1][dir], ny = currentY + [-1, 0, 1, 0][dir];
            if(nx > 0 && nx < w-1 && ny > 0 && ny < h-1) {
                if(map[ny][nx] === 1) { map[ny][nx] = 0; currentX = nx; currentY = ny; steps++; }
            }
        }
        itemX = currentX; itemY = currentY;
        const isRepair = Math.random() > 0.5;
        const itemType = isRepair ? 2 : 4; 
        const goalType = isRepair ? 3 : 5; 
        const reqCmd = isRepair ? 'repair' : 'buy';
        const itemStr = isRepair ? 'screwdriver' : 'coin';
        map[itemY][itemX] = itemType;
        steps = 0;
        while(steps < 4) {
            let dir = Math.floor(Math.random() * 4);
            let nx = currentX + [0, 1, 0, -1][dir], ny = currentY + [-1, 0, 1, 0][dir];
            if(nx > 0 && nx < w-1 && ny > 0 && ny < h-1) {
                if(map[ny][nx] === 1 || map[ny][nx] === 0) {
                    if(map[ny][nx] !== 9 && map[ny][nx] !== itemType) { map[ny][nx] = 0; currentX = nx; currentY = ny; steps++; }
                }
            }
        }
        if(map[currentY][currentX] === 0) map[currentY][currentX] = goalType;
        else for(let y=1; y<h-1; y++) for(let x=1; x<w-1; x++) if(map[y][x]===0) { map[y][x] = goalType; break; }
        return { map: map, w: w, h: h, dir: 1, items: [itemStr], req: reqCmd, hint: `‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö ${levelIndex}: ‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à` };
    }
    while(LEVELS.length < 50) LEVELS.push(generateRandomLevel(LEVELS.length + 1));

    const editor = {
        textarea: document.getElementById('code-input'),
        highlight: document.getElementById('code-highlight'),
        lineNumbers: document.getElementById('line-numbers'),
        console: document.getElementById('console-output'),
        init() {
            this.textarea.addEventListener('input', () => this.update());
            this.textarea.addEventListener('scroll', () => this.syncScroll());
            this.textarea.addEventListener('keydown', (e) => this.handleTab(e));
            this.textarea.value = "# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\nmove_forward(1)";
            this.update();
        },
        update() {
            const text = this.textarea.value;
            let html = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\b(def|if|else|elif|for|while|return|import|from|as|pass|break|continue)\b/g, `<span class="hl-keyword">$1</span>`).replace(/#.*/g, match => `<span class="hl-comment">${match}</span>`).replace(/\b(move_forward|turn_left|turn_right|collect|repair|buy)\b/g, `<span class="hl-func">$1</span>`).replace(/\b(\d+)\b/g, `<span class="hl-num">$1</span>`);
            if (text[text.length-1] === "\n") html += " "; 
            this.highlight.innerHTML = html;
            this.updateLineNumbers(text);
        },
        updateLineNumbers(text) { const lines = text.split('\n').length; this.lineNumbers.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>'); },
        syncScroll() { this.highlight.scrollTop = this.textarea.scrollTop; this.highlight.scrollLeft = this.textarea.scrollLeft; this.lineNumbers.scrollTop = this.textarea.scrollTop; },
        handleTab(e) { if (e.key === 'Tab') { e.preventDefault(); const start = this.textarea.selectionStart; const end = this.textarea.selectionEnd; this.textarea.value = this.textarea.value.substring(0, start) + "    " + this.textarea.value.substring(end); this.textarea.selectionStart = this.textarea.selectionEnd = start + 4; this.update(); } },
        log(msg, type='info') { const line = document.createElement('span'); line.className = `log-line log-${type}`; line.innerText = `> ${msg}`; this.console.appendChild(line); this.console.scrollTop = this.console.scrollHeight; },
        clearLog() { this.console.innerHTML = ''; },
        insert(text) { const start = this.textarea.selectionStart; const end = this.textarea.selectionEnd; const val = this.textarea.value; let prefix = ""; if (start > 0 && val[start-1] !== '\n') prefix = "\n"; this.textarea.value = val.substring(0, start) + prefix + text + val.substring(end); this.update(); this.textarea.focus(); }
    };

    const game = {
        level: 0, grid: [], player: { x:0, y:0, dir:1 }, inventory: [], startState: {}, isRunning: false,
        async init(startLevel) { editor.init(); this.loadLevel(startLevel || 0); document.getElementById('loading-overlay').style.display = 'none'; },
        loadLevel(idx) {
            this.level = idx; const data = LEVELS[idx];
            const container = document.getElementById('grid-container'); container.style.gridTemplateColumns = `repeat(${data.w}, 60px)`; container.innerHTML = '';
            this.grid = [];
            for(let y=0; y<data.h; y++) {
                this.grid[y] = [];
                for(let x=0; x<data.w; x++) {
                    const type = data.map[y][x]; this.grid[y][x] = type;
                    const cell = document.createElement('div'); cell.className = type === 1 ? 'cell cell-wall' : 'cell cell-floor'; cell.id = `cell-${x}-${y}`;
                    if(type === 9) { this.player.x = x; this.player.y = y; } 
                    else if(type === 2) cell.innerHTML = `<div class="item">${ICONS.screwdriver}</div>`;
                    else if(type === 3) cell.innerHTML = `<div class="goal">${ICONS.server_broken}</div>`;
                    else if(type === 4) cell.innerHTML = `<div class="item">${ICONS.coin}</div>`;
                    else if(type === 5) cell.innerHTML = `<div class="goal">${ICONS.vending}</div>`;
                    container.appendChild(cell);
                }
            }
            this.player.dir = data.dir; this.inventory = []; this.startState = { ...this.player };
            const playerEl = document.createElement('div'); playerEl.id = 'player'; playerEl.className = 'player'; playerEl.innerHTML = ICONS.player;
            document.getElementById('grid-container').appendChild(playerEl);
            this.updatePlayerSprite();
            document.getElementById('level-display').innerText = `LEVEL ${idx+1} / 50`;
            document.getElementById('inventory-display').innerText = `üéí ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤: ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤`;
            const titles = { repair: "‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£", buy: "‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" };
            document.getElementById('mission-title').innerText = `‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${titles[data.req] || '‡∏™‡∏≥‡∏£‡∏ß‡∏à'}`;
            document.getElementById('mission-desc').innerText = data.hint;
            document.getElementById('modal-win').classList.remove('show');
            document.getElementById('modal-fail').classList.remove('show');
            editor.clearLog(); editor.log(`Level ${idx+1} Loaded.`); editor.log(`Hint: ${data.hint}`);
        },
        updatePlayerSprite() {
            const el = document.getElementById('player'); el.style.left = `${this.player.x * 64 + 5}px`; el.style.top = `${this.player.y * 64 + 5}px`;
            const rot = [0, 90, 180, 270]; el.style.transform = `rotate(${rot[this.player.dir]}deg)`;
        },
        resetLevel() { this.isRunning = false; this.loadLevel(this.level); },
        async runCode() {
            if(this.isRunning) return;
            this.isRunning = true; editor.clearLog(); editor.log("Running code...", "info");
            const rawCode = document.getElementById('code-input').value; const lines = rawCode.split('\n'); const commands = [];
            try {
                for(let line of lines) {
                    line = line.trim(); if(!line || line.startsWith('#')) continue;
                    const match = line.match(/^([a-z_]+)\s*\((\s*\d*\s*)\)$/);
                    if(!match) throw new Error(`Syntax Error: "${line}"`);
                    const func = match[1]; const arg = match[2] ? parseInt(match[2]) : 1;
                    if(func === 'move_forward') for(let i=0; i<arg; i++) commands.push({cmd: 'move'});
                    else if(['turn_left', 'turn_right', 'collect', 'repair', 'buy'].includes(func)) commands.push({cmd: func});
                    else throw new Error(`Unknown function: "${func}"`);
                }
            } catch(e) { editor.log(e.message, "error"); this.isRunning = false; return; }
            for(let act of commands) {
                if(!this.isRunning) break;
                const success = await this.executeAction(act.cmd);
                if(!success) { sound.play('fail'); this.fail("‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏ä‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ú‡∏¥‡∏î)"); return; }
                await new Promise(r => setTimeout(r, 600));
            }
            const currentTile = this.grid[this.player.y][this.player.x];
            if(this.isRunning) {
                editor.log("Program ended.", "info");
                const req = LEVELS[this.level].req;
                if((req === 'repair' && currentTile === 3) || (req === 'buy' && currentTile === 5)) this.fail(`‡∏Ñ‡∏∏‡∏ì‡∏•‡∏∑‡∏°‡∏™‡∏±‡πà‡∏á ${req}() !`);
                else this.fail("‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                sound.play('fail');
            }
        },
        async executeAction(cmd) {
            if(cmd === 'move') {
                const dx = [0, 1, 0, -1][this.player.dir]; const dy = [-1, 0, 1, 0][this.player.dir];
                const nx = this.player.x + dx; const ny = this.player.y + dy;
                if(nx < 0 || ny < 0 || nx >= LEVELS[this.level].w || ny >= LEVELS[this.level].h || this.grid[ny][nx] === 1) { editor.log("Crash! Hit a wall.", "error"); return false; }
                this.player.x = nx; this.player.y = ny; this.updatePlayerSprite(); editor.log("Moved forward."); sound.play('move');
            } else if(cmd === 'turn_left') {
                this.player.dir = (this.player.dir - 1 + 4) % 4; this.updatePlayerSprite(); editor.log("Turned left."); sound.play('turn');
            } else if(cmd === 'turn_right') {
                this.player.dir = (this.player.dir + 1) % 4; this.updatePlayerSprite(); editor.log("Turned right."); sound.play('turn');
            } else if(cmd === 'collect') {
                const tile = this.grid[this.player.y][this.player.x]; const cell = document.getElementById(`cell-${this.player.x}-${this.player.y}`);
                if(tile === 2) { this.inventory.push('screwdriver'); this.grid[this.player.y][this.player.x] = 0; cell.innerHTML = ''; this.updateInventoryUI(); editor.log("Collected Screwdriver.", "success"); sound.play('collect'); }
                else if(tile === 4) { this.inventory.push('coin'); this.grid[this.player.y][this.player.x] = 0; cell.innerHTML = ''; this.updateInventoryUI(); editor.log("Collected Coin.", "success"); sound.play('collect'); }
                else { editor.log("Nothing to collect here.", "error"); return false; }
            } else if(cmd === 'repair') {
                const tile = this.grid[this.player.y][this.player.x];
                if(tile === 3) {
                    const levelData = LEVELS[this.level]; const requiresTool = levelData.items && levelData.items.includes('screwdriver');
                    if(!requiresTool || this.inventory.includes('screwdriver')) {
                        const cell = document.getElementById(`cell-${this.player.x}-${this.player.y}`); cell.innerHTML = `<div class="goal">${ICONS.server_fixed}</div>`; editor.log("Server Repaired!", "success"); sound.play('action'); this.win();
                    } else { editor.log("Need Screwdriver to repair!", "error"); return false; }
                } else { editor.log("Nothing to repair here.", "error"); return false; }
            } else if(cmd === 'buy') {
                const tile = this.grid[this.player.y][this.player.x];
                if(tile === 5) {
                    if(this.inventory.includes('coin')) { editor.log("Item Purchased!", "success"); sound.play('action'); this.win(); }
                    else { editor.log("Need Coin to buy!", "error"); return false; }
                } else { editor.log("Not a vending machine.", "error"); return false; }
            }
            return true;
        },
        updateInventoryUI() { const items = this.inventory.map(i => i === 'screwdriver' ? '‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏á' : '‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç').join(', '); document.getElementById('inventory-display').innerText = `üéí ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤: ${items || '‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤'}`; },
        fail(msg) { this.isRunning = false; document.getElementById('fail-msg').innerText = msg; document.getElementById('modal-fail').classList.add('show'); },
        win() { this.isRunning = false; DataManager.saveProgress('text', this.level + 1); document.getElementById('modal-win').classList.add('show'); sound.play('win'); },
        nextLevel() { if(this.level < LEVELS.length - 1) { this.loadLevel(this.level + 1); } else { alert("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå!"); } }
    };

    async function waitForData() {
        if(!sessionStorage.getItem('coding_student_id')) return 0;
        for(let i=0; i<30; i++) {
            if(DataManager.currentUser) return DataManager.getLevel('text');
            await new Promise(r => setTimeout(r, 100));
        }
        return 0; 
    }

    window.onload = async () => {
        const savedLevel = await waitForData();
        game.init(savedLevel);
    };
</script>
<style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
</body>
</html>