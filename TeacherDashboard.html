<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - Coding Academy</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- DataManager (‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå DataManager.js ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) -->
    <script src="DataManager.js"></script> 
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #1e293b; display: flex; align-items: center; gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #64748b; font-weight: bold; }
        tr:hover { background: #f1f5f9; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; color: white; font-weight: bold; display: inline-block; min-width: 50px; text-align: center; }
        .b-icon { background: #facc15; color: #854d0e; }
        .b-block { background: #4ade80; color: #14532d; }
        .b-text { background: #38bdf8; color: #0c4a6e; }
        .search-box { padding: 10px; width: 100%; max-width: 300px; border: 1px solid #cbd5e1; border-radius: 5px; margin-bottom: 10px; }
        .refresh-btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; float: right; transition: 0.2s; }
        .refresh-btn:hover { background: #2563eb; }
        .status-msg { text-align: center; padding: 20px; color: #64748b; }
        .error-msg { color: #ef4444; background: #fee2e2; padding: 10px; border-radius: 5px; border: 1px solid #fca5a5; }
    </style>
</head>
<body>
    <div class="container">
        <button class="refresh-btn" onclick="loadData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <h1>üë®‚Äçüè´ ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h1>
        <p>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
        
        <input type="text" id="searchInput" class="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." onkeyup="filterTable()">

        <table id="studentTable">
            <thead>
                <tr>
                    <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                    <th>Icon (‡πÄ‡∏ï‡πá‡∏° 20)</th>
                    <th>Block (‡πÄ‡∏ï‡πá‡∏° 100)</th>
                    <th>Text (‡πÄ‡∏ï‡πá‡∏° 50)</th>
                    <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="5" class="status-msg">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // ‡πÉ‡∏ä‡πâ window.onload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå script ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
        window.onload = function() {
            setTimeout(loadData, 500);
        };

        async function loadData() {
            const tbody = document.getElementById('tableBody');

            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå DataManager.js ‡∏ï‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (typeof DataManager === 'undefined') {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="status-msg">
                            <div class="error-msg">
                                ‚ùå <b>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå DataManager.js</b><br>
                                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå <code>DataManager.js</code> ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
            if (!DataManager.db && DataManager.isOnline) {
                // ‡∏ñ‡πâ‡∏≤ isOnline ‡πÄ‡∏õ‡πá‡∏ô true ‡πÅ‡∏ï‡πà db ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ config
                tbody.innerHTML = '<tr><td colspan="5" class="status-msg">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)</td></tr>';
                // ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setTimeout(loadData, 1000); 
                return;
            }

            if (!DataManager.db) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="status-msg">
                            <div class="error-msg" style="color:orange; border-color:orange; background:#fff7ed;">
                                ‚ö†Ô∏è <b>‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (Offline Mode)</b><br>
                                ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Config<br>
                                (‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Cloud)
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = '<tr><td colspan="5" class="status-msg">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</td></tr>';

            try {
                const snapshot = await DataManager.db.collection("students").get();
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="status-msg">üì≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
                    return;
                }

                tbody.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let lastLogin = '-';
                    if (data.lastLogin) {
                        const d = new Date(data.lastLogin);
                        lastLogin = d.toLocaleDateString('th-TH') + ' ' + d.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                    }
                    
                    const row = `
                        <tr>
                            <td style="font-weight:bold; color:#334155;">${doc.id}</td>
                            <td><span class="badge b-icon">Lv. ${data.iconLevel || 0}</span></td>
                            <td><span class="badge b-block">Lv. ${data.blockLevel || 0}</span></td>
                            <td><span class="badge b-text">Lv. ${data.textLevel || 0}</span></td>
                            <td style="color:#64748b; font-size:0.9em;">${lastLogin}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="5" class="status-msg"><div class="error-msg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.message}</div></td></tr>`;
            }
        }

        function filterTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toUpperCase();
            const table = document.getElementById("studentTable");
            const tr = table.getElementsByTagName("tr");

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏µ‡πà index 1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô loading/error message (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ header
            // ‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤ replace tbody content ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ tr ‡πÉ‡∏ô tbody ‡∏à‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤
            const rows = document.getElementById('tableBody').getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ó‡∏µ‡πà‡∏°‡∏µ class status-msg)
                if (rows[i].querySelector('.status-msg')) continue;

                const td = rows[i].getElementsByTagName("td")[0]; // ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    rows[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        }
    </script>
</body>
</html>